# Трекинг движущихся объектов на конвейере

## Введение
**Описание проекта:** 
Renue – IT-компании из Екатеринбурга, которая разрабатывает высоконагруженные и отказоустойчивые решения для крупных российских заказчиков, требуется создать решение для отслеживания и сортировки мусора на конвейере – выделять пластиковые бутылки в общем потоке предметов.

**Цель проекта:**  
Создать модель потокового трекинга пластиковой тары на конвейере, которая выдает координаты центра обнаруженных объектов для каждого видеокадра.
Скорость обработки потока должна быть не более 100 мс.
Метрика оценки модели –  *MOTA* (Multiple Object Tracking Accuracy).

**Данные:**
- Предобученная модель детекции пластиковых бутылок и пример кода для ее запуска.
- Датасет с изображениями и разметкой в нескольких форматах: MOT, COCO, CVAT.
- Примеры видеозаписей работы конвейера.

## Методы

**Библиотеки:**

- Python, Ultralytics, Motmetrics, OpenCV, PyTorch, Numpy, SciPy, time, timedelta,  PIL, OS, Glob.

**Модели и алгоритмы:**

- *Ultralytics YOLO*(версия YOLOv10): популярная одноэтапная **модель обнаружения объектов** и сегментации изображений в реальном времени с высокой производительностью и точностью. Модель сохраняет уникальный идентификатор каждого обнаруженного в кадре объекта по мере продвижения видео [`Ultralitics Yolo`](https://docs.ultralytics.com/ru/modes/track/) . 


- *BoT-Sort* (Robust Associations Multi-Pedestrian Tracking): надежный **современный трекер**, сочетающий преимущества информации о движении и внешнем виде вместе с компенсацией движения камеры и более точным вектором состояния фильтра Калмана  [`BoT-Sort`](https://github.com/NirAharon/BoT-SORT) .


- *ByteTrack*: современный **алгоритм трекинга** c высокой производительностью и точностью [`ByteTrack`](https://github.com/ifzhang/ByteTrack) .


**Оценка качества:**

- Для оценки качества моделей мы использовали метрику ***MOTA*** (Multiple Object Tracking Accuracy) из библиотеки py-motmetrics [`py-motmetrics`](https://github.com/cheind/py-motmetrics):  метрика рассчитывает правильность обнаружения объектов в кадре на основе данных об истинных значениях и результатах отслеживания.  

$$
\displaystyle MOTA=1-\frac{\sum_t FN_t+FP_t+IDS_t}{\sum_t GT_t}\
$$

$$
\displaystyle\textrm {Вычитаем из единицы отношение количества ошибок к количеству истинных объектов, рассчитанное по кадрам.}
$$

- Из вспомогательных метрик мы использовали Precision, Recall и **MOTP** (Multiple Object Tracking Precision) из библиотеки py-motmetrics [`py-motmetrics`](https://github.com/cheind/py-motmetrics): MOTP – это отношение между суммой расстояний между сопоставленными объектами и количеством таких сопоставлений.

$$
\displaystyle MOTP=\frac{\sum_{i,t} d_t^i}{\sum_t c_t}\
$$


МОТР хорошо оценивает ошибки определения расположения объекта в кадре, учитывая в результате только те объекты, которые удалось засечь трекеру и в значительной степени зависит от качества детектора.


## Структура исследования

Сложность задачи заключалась в подборе алгоритма, который, с одной стороны, покажет хорошую метрику сопровождения объектов, причем, не только на статичных кадрах, но и в реальном времени, а с другой, сделает это быстро – за время не превышающее 100 мс.    

В начале исследования мы создали и опробовали базовую модель (baseline) детектора объектов со встроенным трекером. В качестве Baseline мы выбрали предобученную модель YOLOv10 c трекером BoT-SORT по умолчанию. Мы проверили работу модели на датасете со 100 изображениями в фрмате JPG и на 8-секундном фрагменте видео в формате mp4. 

Модель сразу же показала хорошую метрику (MOTA = 0.912409), но скорость обработки одного кадра оставляла желать лучшего (125.75 мс). Результаты работы модели мы занесли в таблицу. 

На следующем шаге мы исследовали и применяли различные варианты улучшения работы модели: тестировали модель с разными сочетаниями гиперпараметров и алгоритмов трекинга, визуализируя результаты.  


Одновременно, мы анализировали и сохраняли полученные результаты.

Также мы запускали модель обнаруживать и сопровождать объекты на потоковом видео. При чем, мы выбирали видео в разном разрешении.  

На финальном шаге мы аккумулировали результаты в итоговую таблицу, сформулировали и оформили выводы. 


## Результаты

**Таблица с результатами:**

| Модель | Трекер |Формат входного изображения| Количество кадров| Параметр imgsz| Recall | Precision | MOTA | MOTP | Время вывода одного кадра |Общее время вывода |
|:---- |:------ |:---------|:------- | :---------|:------ |:--------- | :------- |:------ |:--------- | :------- |
| YOLOv10(baseline)|**BoT-SORT** |**jpg**|100|640|      |     | | | | |
| YOLOv10|BoT-SORT |jpg|100|480|0.918854|1.0|0.914081|0.088913|125.75 ms|0:00:12.575490 min:s|
| YOLOv10|BoT-SORT |jpg|400|480|      |  |  |  | | |
| YOLOv10|BoT-SORT |jpg|400|352|      |  |  | |  | |
| YOLOv10|BoT-SORT |**mp4**|99 |480|0.917275|1.0|0.912409|0.089113|105.42 ms|0:00:10.436469 min:s|
| YOLOv10|BoT-SORT |mp4|99 |352|0.917275|1.0|0.912409| 0.089113| 90.64 ms |0:00:08.973363 min:s|
| YOLOv10|BoT-SORT |mp4|**21565**|480|0.921751|0.998905| **0.917861**|0.080872|1105.49 ms|0:37:54.856070 min:s|
| YOLOv10|BoT-SORT |mp4|21565|352|0.912338|0.999576|0.909136|0.092135|**91.56 ms**|0:32:54.551819 min:s|
| YOLOv10|**ByteTrack**|mp4|99 |640|0.917275|1.0|**0.912409**|0.089113|61.28 ms|0:00:06.066682 min:s|
| YOLOv10|ByteTrack|mp4|99 |352|0.917275|1.0|0.912409| 0.089113|**33.71 ms** |0:00:03.337105 min:s|
| YOLOv10)|**ByteTrack**|mp4|21565|352| | |   | |||


**Анализ результатов:**

- Судя по результатам, модель очень хорошо справляется с разными форматами и разным количеством кадров, показывая высокую метрику.

- При уменьшении размера изображения для вывода (imgsz) метрика снижалась: модели удавалось обнаружить меньше объектов.   

- При работе с большим количеством кадров модель показывала чуть меньшую метрику: видимо, чем крупнее датасет, тем  больше накапливается ошибок. 

- Трекеры показали схожие результаты, но ByteTrack был значительно быстрее.  


## Выводы

**Выбор модели для заявленных целей:** 

Для заявленной цели – создать модель потокового трекинга пластиковой тары на конвейере, которая выдает координаты центра обнаруженных объектов для каждого видеокадра со скоростью обработки потока не более 100 мс – больше подойдет предобученная модель YOLOv10 с трекером ByteTrack.


## Команда проекта

- Федор Сафонов  (TeamLead)
- Анна Йорданова
- Юрий Кашин
- Александр Вотинов
- Гульшат Зарипова
- Сергей Пашкин
- Александр Глазунов